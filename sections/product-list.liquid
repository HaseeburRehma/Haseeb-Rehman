<style>
/* GRID */

.product-grid {
  width: 100vw;
  margin-left: 50%;
  transform: translateX(-50%);
  padding: 40px 16px;
}
.product-grid__container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 24px;
}

.product-grid__item {
  position: relative;
  aspect-ratio: 1;
  overflow: hidden;
  cursor: pointer;
}

.product-grid__item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* PLUS ICON */
.product-grid__plus {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 22px;
  height: 22px;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 50%;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}

/* POPUP OVERLAY */
.product-popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.product-popup.active {
  display: flex;
}

/* POPUP CARD */
.product-popup__content {
  background: #fff;
  width: 100%;
  max-width: 360px;
  padding: 24px;
  position: relative;
}

/* CLOSE */
.product-popup__close {
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 20px;
  cursor: pointer;
}

/* TOP SECTION (TEXT + IMAGE PARALLEL) */
.product-popup__top {
  display: grid;
  grid-template-columns: 1fr 140px;
  gap: 20px;
  margin-bottom: 24px;
  align-items: flex-start;
}


/* TEXT */
.product-popup__text h3 {
  font-size: 18px;
  font-weight: 500;
  margin-bottom: 6px;
}

.product-popup__price {
  font-size: 16px;
  margin-bottom: 12px;
}

.product-popup__desc {
  font-size: 14px;
  line-height: 1.45;
}

/* IMAGE */
.product-popup__image {
  width: 140px;
  height: 180px;
  overflow: hidden;
}

.product-popup__image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* VARIANTS */


.variant-group label {
  font-size: 14px;
  margin-bottom: 6px;
  display: block;
}

.variant-buttons {
  display: flex;
  border: 1px solid #000;
}

.variant-buttons button {
  flex: 1;
  padding: 12px;
  background: #fff;
  border: none;
  font-size: 14px;
  cursor: pointer;
}

.variant-buttons button + button {
  border-left: 1px solid #000;
}

.variant-buttons button.active {
  background: #000;
  color: #fff;
}

.variant-buttons button:last-child {
  border-right: none;
}

.variant-buttons button.active {
  background: #000;
  color: #fff;
}

.variant-group {
  margin-bottom: 18px;
}

/* SELECT WRAPPER */
.select-wrapper {
  position: relative;
}

/* SELECT */
.select-wrapper select {
  width: 100%;
  padding: 14px 48px 14px 16px;
  border: 1px solid #000;
  background: #fff;
  font-size: 14px;
  appearance: none;
  outline: none;
  box-sizing: border-box;

  background-image: url("data:image/svg+xml,%3Csvg width='14' height='8' viewBox='0 0 14 8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l6 6 6-6' stroke='%23000' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 16px center;
}

.select-wrapper::after {
  content: "";
  position: absolute;
  right: 44px;
  top: 1px;
  bottom: 1px;
  width: 1px;
  background: #000;
  pointer-events: none;
}



.add-to-cart {
  width: 100%;
  margin-top: 20px;
  padding: 14px 20px;
  background: #000;
  color: #fff;
  border: none;
  font-size: 14px;
  cursor: pointer;

  display: flex;
  justify-content: center;
  align-items: center;
  gap: 16px;
}

.cart-arrow {
  width: 18px;
  height: 1px;
  background: #fff;
  position: relative;
}

.cart-arrow::after {
  content: "";
  position: absolute;
  right: -2px;
  top: -4px;
  width: 8px;
  height: 8px;
  border-top: 1px solid #fff;
  border-right: 1px solid #fff;
  transform: rotate(45deg);
}




@media (max-width: 768px) {

  .product-grid__container {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .product-grid__item {
    aspect-ratio: 1 / 1;
  }

}




</style>

<section class="product-grid">
  <div class="product-grid__container">
    {% for block in section.blocks %}
      {% assign product = all_products[block.settings.product] %}
      {% if product %}
        <div class="product-grid__item" data-handle="{{ product.handle }}">
          <img src="{{ product.featured_image | img_url: 'large' }}" alt="{{ product.title }}">
          <div class="product-grid__plus">+</div>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</section>

<div class="product-popup" id="popup">
  <div class="product-popup__content">
   <span class="product-popup__close" id="closePopup">&times;</span>

<div class="product-popup__top">
   <div class="product-popup__image">
    <img id="popupImage">
  </div>
  <div class="product-popup__text">
    <h3 id="popupTitle"></h3>
    <div class="product-popup__price" id="popupPrice"></div>
    <div class="product-popup__desc" id="popupDesc"></div>
  </div>

 
</div>

<div id="popupVariants"></div>

<button class="add-to-cart" id="addToCartBtn">
  <span>ADD TO CART</span>
  <span class="cart-arrow"></span>
</button>

</div>

<script>
const products = {
{% for block in section.blocks %}
{% assign p = all_products[block.settings.product] %}
{% if p %}
"{{ p.handle }}": {{ p | json }}{% unless forloop.last %},{% endunless %}
{% endif %}
{% endfor %}
};

let activeProduct = null;
let selected = {};
let activeVariant = null;

document.querySelectorAll('.product-grid__item').forEach(item => {
  item.addEventListener('click', () => openPopup(item.dataset.handle));
});

function openPopup(handle) {
  activeProduct = products[handle];
  selected = {};
  activeVariant = null;

  document.getElementById('popup').classList.add('active');

  const img = activeProduct.featured_image?.src || activeProduct.images[0];
  document.getElementById('popupImage').src = img;
  document.getElementById('popupTitle').textContent = activeProduct.title;
  document.getElementById('popupDesc').innerHTML = activeProduct.description;
  document.getElementById('popupPrice').textContent =
    (activeProduct.variants[0].price / 100).toFixed(2) + '€';

  document.getElementById('addToCartBtn').dataset.id = "";
  renderVariants();
}

document.getElementById('closePopup').onclick = () =>
  document.getElementById('popup').classList.remove('active');

function renderVariants() {
  const container = document.getElementById('popupVariants');
  container.innerHTML = '';

  activeProduct.options.forEach((opt, i) => {
    const values = [...new Set(activeProduct.variants.map(v => v[`option${i+1}`]))];
    const group = document.createElement('div');
    group.className = 'variant-group';

    const label = document.createElement('label');
    label.textContent = opt;
    group.appendChild(label);

    if (opt.toLowerCase() === 'color') {
      const buttons = document.createElement('div');
      buttons.className = 'variant-buttons';

      values.forEach(val => {
        const btn = document.createElement('button');
        btn.textContent = val;
        btn.onclick = () => {
          selected[opt] = val;
          [...buttons.children].forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          resolveVariant();
        };
        buttons.appendChild(btn);
      });

      group.appendChild(buttons);
    } else {
      const wrapper = document.createElement('div');
      wrapper.className = 'select-wrapper';

      const select = document.createElement('select');
      select.innerHTML = `<option value="">Choose your ${opt}</option>`;

      values.forEach(val => {
        const o = document.createElement('option');
        o.value = val;
        o.textContent = val;
        select.appendChild(o);
      });

      select.onchange = () => {
        selected[opt] = select.value;
        resolveVariant();
      };

      wrapper.appendChild(select);
      group.appendChild(wrapper);
    }

    container.appendChild(group);
  });
}

function resolveVariant() {
  activeVariant = activeProduct.variants.find(v =>
    activeProduct.options.every((opt, i) =>
      selected[opt] && v[`option${i+1}`] === selected[opt]
    )
  );

  if (activeVariant) {
    document.getElementById('popupPrice').textContent =
      (activeVariant.price / 100).toFixed(2) + '€';
    document.getElementById('addToCartBtn').dataset.id = activeVariant.id;
  }
}

document.getElementById('addToCartBtn').onclick = async () => {
  if (!activeVariant) {
    alert("Please select all options");
    return;
  }

  await fetch('/cart/add.js', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      items: [{ id: activeVariant.id, quantity: 1 }]
    })
  });

  document.getElementById('popup').classList.remove('active');
};
</script>

{% schema %}
{
  "name": "Product Grid",
  "max_blocks": 20,
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        { "type": "product", "id": "product", "label": "Select product" }
      ]
    }
  ],
  "presets": [
    { "name": "Product Grid" }
  ]
}
{% endschema %}
